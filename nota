#!/bin/sh

config="${XDG_CONFIG_HOME:-"$HOME/.config"}/nota"

# shellcheck disable=SC1090
[ -f "$config" ] && . "$config"

data_base_dir=${XDG_DATA_HOME:-"$HOME/.local/share"}
data_dir=$data_base_dir/nota

cd -- "$data_dir" || exit

editor=${EDITOR:-${VISUAL:-vi}}

unsanitised_basename=${1:-"$(date +%F)"}

# Can't use ${file//...} because it's undefined in POSIX sh
basename=$(printf '%s' "$unsanitised_basename" | tr / _)
file=$data_dir/$basename
[ "$GPG" ] && file+=.gpg


export GIT_DIR="$data_dir/.git"
export GIT_WORK_TREE="$data_dir"

case $1 in
    git|ls) exec "$@" ;;
esac

mkdir -p "$data_dir"

"$editor" -- "$file"

# It's possible we exited the editor without creating a file in the new case
if ! [ -f "$file" ]; then
    printf 'Not committing as %s is missing\n' "$unsanitised_basename" >&2
    exit 5
fi

git init
git add "$file"
git commit -m "Updated $unsanitised_basename"
